<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ShoeStore ‚Äì AI Recommendation System</title>
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            background: linear-gradient(135deg, #f7f7f7, #ffffff);
            margin: 0;
            padding: 0;
            text-align: center;
        }

        h1 {
            background-color: #222;
            color: #fff;
            padding: 20px;
            margin: 0;
            font-size: 26px;
            letter-spacing: 1px;
        }

        .cart-bar {
            position: absolute;
            right: 25px;
            top: 20px;
            background: #ff5c00;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        form {
            margin: 30px auto;
            background: #fff;
            display: inline-block;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        input[type="text"], select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-right: 10px;
            outline: none;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #ff5c00;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #ff7a33;
        }

        h2 {
            color: #333;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .recommendation-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            padding: 20px;
        }

        .recommendation {
            background: white;
            border-radius: 15px;
            width: 230px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .recommendation:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.15);
        }

        .recommendation img {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            object-fit: cover;
        }

        .recommendation h3 {
            color: #333;
            font-size: 18px;
            margin: 10px 0 5px;
        }

        .price {
            color: #ff5c00;
            font-weight: bold;
            font-size: 16px;
        }

        .buttons {
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
            border: none;
            color: white;
            transition: 0.3s;
        }

        .btn-cart { background-color: #28a745; }
        .btn-cart:hover { background-color: #33c258; }
        .btn-buy { background-color: #007bff; }
        .btn-buy:hover { background-color: #2894ff; }

        /* Popup base */
        .popup {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 400px;
            text-align: left;
            max-height: 90vh;
            overflow-y: auto;
        }

        .popup-content h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        label { display: block; margin-top: 10px; font-weight: 600; }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-top: 5px;
        }

        .pay-btn {
            background: #28a745;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 8px;
            width: 100%;
            margin-top: 15px;
            font-size: 16px;
            cursor: pointer;
        }

        .pay-btn:hover { background: #33c258; }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }

        .cart-item img {
            width: 65px;
            height: 65px;
            border-radius: 10px;
        }

        .cart-total {
            text-align: center;
            font-size: 18px;
            margin-top: 15px;
            font-weight: bold;
        }

        footer {
            margin-top: 50px;
            padding: 15px;
            background: #222;
            color: #ccc;
            font-size: 14px;
        }
        /* --- UPI ICON ADD-ON --- */
        .upi-icons {
            display: flex;
            justify-content: space-evenly;
            margin: 15px 0;
        }

        .upi-icons img {
            width: 60px;
            cursor: pointer;
            border-radius: 10px;
            padding: 5px;
            border: 2px solid transparent;
            transition: 0.3s;
        }

        .upi-icons img:hover {
            transform: scale(1.1);
        }

        .upi-icons img.active {
            border-color: #28a745;
        }
        .upi-icons {
            display: flex;
            justify-content: space-evenly;
            margin: 15px 0;
        }

        .upi-icons img {
            width: 65px;
            padding: 8px;
            border-radius: 12px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: 0.3s;
        }

        .upi-icons img.active {
            border-color: #28a745;
            box-shadow: 0 0 8px rgba(40,167,69,0.6);
        }

        </style>
        </head>
        <body>
            <h1>üëü ShoeStore ‚Äì AI based Hybrid Recommendation System</h1>
            <div class="cart-bar" onclick="openCart()">üõí Cart: <span id="cart-count">0</span></div>
            <div class="cart-bar" style="right:120px;background:#0d6efd" onclick="openAccount()">
            üë§ Account
            </div>

            <form method="post">
                <input type="text" name="user_id" placeholder="Enter User ID" required value="{{ user_id or '' }}">
                <select name="method">
                    <option value="collab" {% if method == 'collab' %}selected{% endif %}>Collaborative Filtering</option>
                    <option value="slp" {% if method == 'slp' %}selected{% endif %}>Single Layer Perceptron (SLP)</option>
                    <option value="mlp" {% if method == 'mlp' %}selected{% endif %}>Multi Layer Perceptron (MLP)</option>
                </select>
                <button type="submit">Get Recommendations</button>
            </form>

            <h2>Recommended Shoes</h2>
            <div class="recommendation-container">
                {% for rec in recommendations %}
                    <div class="recommendation">
                        <img src="{{ rec.image_url }}" alt="{{ rec.title }}">
                        <h3>{{ rec.title }}</h3>
                        <p class="price">‚Çπ{{ loop.index * 999 }}</p>
                        <div class="buttons">
                            <button class="btn-small btn-cart" onclick="addToCart('{{ rec.title }}', '{{ rec.image_url }}', {{ loop.index * 999 }})">Add to Cart</button>
                            <button class="btn-small btn-buy" onclick="openPayment('{{ rec.title }}', {{ loop.index * 999 }})">Buy Now</button>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Cart View Popup -->
            <div id="cartPopup" class="popup">
                <div class="popup-content">
                    <h3>üõí Your Shopping Cart</h3>
                    <div id="cart-items"></div>
                    <div class="cart-total" id="cart-total"></div>
                    <button class="pay-btn" onclick="checkoutCart()">Checkout</button>
                    <button class="pay-btn" style="background:#ccc; color:#000" onclick="closeCart()">Close</button>
                </div>
            </div>
            
            <div id="accountPopup" class="popup">
                <div class="popup-content">
                <h3>üë§ Your Orders</h3>
                <div id="orderList"></div>

                <button class="pay-btn" style="background:#ccc;color:#000" onclick="closeAccount()">
                    Close
                </button>
                </div>
            </div>


        <!-- Payment Gateway Popup -->
        <div id="paymentPopup" class="popup">
            <div class="popup-content">
                <h3>üí≥ Secure Payment</h3>
                <p id="paymentItem"></p>
                <label>Payment Method:</label>
                <select id="payMethod">
                    <option>Credit/Debit Card</option>
                    <option>UPI</option>
                </select>

                <div id="cardDetails">
                    <label>Card Number:</label>
                    <input type="number" placeholder="1234 5678 9876 5432">
                    <label>Expiry:</label>
                    <input type="text" placeholder="MM/YY">
                    <label>CVV:</label>
                    <input type="number" placeholder="123">
                </div>
                <div id="upiDetails" style="display:none;">
                <div class="upi-icons">
                    <img src="/static/images/gpay.png" id="gpay" onclick="selectUPI('GPay')">
                    <img src="/static/images/phonepe.png" id="phonepe" onclick="selectUPI('PhonePe')">
                </div>

                <!-- OTHER UPI OPTION -->
                <label style="margin-top:10px;">
                <input type="radio" name="upiType" onclick="selectUPI('OTHER')">
                    Other UPI ID
                </label>

                <input type="text" id="upiId"
            placeholder="example@upi"
            style="display:none;"
            oninput="validateUPI()">
                </div>


                <button class="pay-btn" onclick="completePayment()">Pay Now</button>
                <button class="pay-btn" style="background:#ccc; color:#000" onclick="closePayment()">Cancel</button>
            </div>
        </div>
        
        

        <footer>¬© 2025 ShoeStore.ai ‚Äì Smart Shoe Recommender System</footer>

        <script>
            /* FAKE GATEWAY FAILURE UPI IDs */
            const GATEWAY_FAIL_UPI = ["fail@upi", "bankdown@upi"];

            function isGatewayFailureUPI(upi) {
                return GATEWAY_FAIL_UPI.includes(upi.toLowerCase());
            }

            let cart = [];
            let selectedItem = "";

            function addToCart(itemName, img, price) {
                cart.push({ name: itemName, image: img, price: price });
                document.getElementById('cart-count').innerText = cart.length;
                alert(itemName + " added to cart üõí");
            }

            function openCart() {
                let cartItemsDiv = document.getElementById('cart-items');
                cartItemsDiv.innerHTML = "";
                let total = 0;

                cart.forEach(item => {
                    total += item.price;
                    cartItemsDiv.innerHTML += `
                        <div class="cart-item">
                            <img src="${item.image}" alt="">
                            <span>${item.name}</span>
                            <span>‚Çπ${item.price}</span>
                        </div>`;
                });

                if (cart.length === 0) {
                    cartItemsDiv.innerHTML = "<p>Your cart is empty üõçÔ∏è</p>";
                    document.getElementById('cart-total').innerText = "";
                } else {
                    document.getElementById('cart-total').innerText = "Total: ‚Çπ" + total;
                }

                document.getElementById('cartPopup').style.display = 'flex';
            }

            function openAccount() {
                let orders = JSON.parse(localStorage.getItem("orders")) || [];
                let orderDiv = document.getElementById("orderList");
                orderDiv.innerHTML = "";

                if (orders.length === 0) {
                    orderDiv.innerHTML = "<p>No successful orders found.</p>";
                } else {
                    orders.forEach(o => {
                        // Use data-order to safely store the JSON string
                        orderDiv.innerHTML += `
                            <div style="border-bottom:1px solid #ddd;padding:10px 0">
                                <p><b>Order ID:</b> ${o.id}</p>
                                <p><b>Shoe:</b> ${o.item}</p>
                                <p><b>Amount:</b> ‚Çπ${o.price}</p>
                                <p><b>Payment:</b> ${o.method}</p>
                                <p><b>Status:</b> ${o.status || "SUCCESS"}</p>

                                ${o.status === "FAILED"
                                    ? `<p style="color:red"><b>Reason:</b> ${o.message || "Payment failed"}</p>`
                                : `<button class="download-invoice-btn" data-order='${JSON.stringify(o).replace(/'/g,"&#39;")}'>
                                    ‚¨á View / Download Invoice
                                </button>`}
                        </div>
                    `;
                });
                    }

        document.getElementById("accountPopup").style.display = "flex";
}

        function closeAccount() {
            document.getElementById("accountPopup").style.display = "none";
        }


        function closeCart() {
            document.getElementById('cartPopup').style.display = 'none';
        }

        function checkoutCart() {
            if (cart.length === 0) {
                alert("Your cart is empty!");
                return;
            }
            closeCart();
            openPayment("Cart Checkout (" + cart.length + " items)", cart.reduce((t, i) => t + i.price, 0));
        }
        
        document.getElementById("payMethod").addEventListener("change", function () {
            let method = this.value;
            document.getElementById("cardDetails").style.display = method === "UPI" ? "none" : "block";
            document.getElementById("upiDetails").style.display = method === "UPI" ? "block" : "none";
        });



        function openPayment(itemName, price) {
            selectedItem = itemName;
            selectedPrice = price;

    // RESET UPI
            selectedUPIApp = "";
            selectedUPIType = "";
            document.getElementById("gpay").classList.remove("active");
            document.getElementById("phonepe").classList.remove("active");
            document.getElementById("upiId").value = "";
            document.getElementById("upiId").style.display = "none";

            document.getElementById("paymentItem").innerText =
                "You are buying: " + itemName + " ‚Äì ‚Çπ" + price;

            document.getElementById("paymentPopup").style.display = "flex";
        }

         function completePayment() {
            let method = document.getElementById("payMethod").value;
            let paymentSuccess = false;
            if (method === "UPI") {

        // Force manual selection
                if (!selectedUPIApp && selectedUPIType !== "OTHER") {
                    alert("‚ùå Please select GPay, PhonePe, or Other UPI");
                    return;
                }

        // GPay / PhonePe
                if (selectedUPIApp) {
                    alert("‚úÖ Your " + selectedUPIApp + " payment was successful!");
                    paymentSuccess = true;
                }

        // Other UPI
                else {
                    if (!validateUPI()) {
                        alert("‚ùå Invalid UPI ID");
                            return; // ‚ùå DO NOT SAVE ORDER
                    }
                    let upi = document.getElementById("upiId").value.trim();

                    if (isGatewayFailureUPI(upi)) {
                        alert("‚ùå Payment failed due to bank/gateway issue");
                        saveFailedOrder(method,"Gateway failure ‚Äì bank/server issue"); // ‚ùå FAILED ORDER SAVED
                        return;
                    }
                    alert("‚úÖ Your UPI payment was successful!");
                    paymentSuccess = true;
                }
            }
            else {
                let cardNumber = document.querySelector("#cardDetails input[type='number']").value;
                let expiry = document.querySelector("#cardDetails input[type='text']").value;
                let cvv = document.querySelectorAll("#cardDetails input[type='number']")[1].value;

            if (
                !/^\d{16}$/.test(cardNumber) ||
                !/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry) ||
                !/^\d{3}$/.test(cvv)
            ) {
                alert("‚ùå Invalid card details");
                return;
            }
            paymentSuccess = true;
            }
        // ‚úÖ SAVE ORDER + SHOW INVOICE AFTER SUCCESS
            if (paymentSuccess) {
                saveOrder(selectedItem, selectedPrice, method);

                cart = [];
                document.getElementById("cart-count").innerText = 0;
                closePayment();
            }
        }
        function saveFailedOrder(method,reason) {
            let orders = JSON.parse(localStorage.getItem("orders")) || [];
            
            orders.push({
                id: "ORD" + Date.now(),
                item: selectedItem || "N/A",
                price: selectedPrice || "N/A",
                method: method,
                status: "FAILED",
                message:reason,
                date: new Date().toLocaleString()
            });
        localStorage.setItem("orders", JSON.stringify(orders));
        }

        let selectedUPIApp = "";
        let selectedUPIType = "";

        function selectUPI(type) {
            selectedUPIType = type;
            selectedUPIApp = "";

    // reset UI
            document.getElementById("gpay").classList.remove("active");
            document.getElementById("phonepe").classList.remove("active");
            document.getElementById("upiId").style.display = "none";

            if (type === "GPay" || type === "PhonePe") {
                selectedUPIApp = type;
                document.getElementById(type === "GPay" ? "gpay" : "phonepe")
                .classList.add("active");
            }

            if (type === "OTHER") {
                document.getElementById("upiId").style.display = "block";
            }
        }
        function validateUPI() {
                let upi = document.getElementById("upiId").value.trim();
                let regex = /^[\w.-]+@[\w.-]+$/;
                return regex.test(upi);
        }

        function closePayment() {
            document.getElementById('paymentPopup').style.display = 'none';
        }
        
        function saveOrder(itemName, amount, paymentMethod) {
            let orders = JSON.parse(localStorage.getItem("orders")) || [];

            let order = {
            id: "ORD" + Date.now(),
            item: itemName,
            price: amount,
            method: paymentMethod,
            date: new Date().toLocaleString()
        };

        orders.push(order);
        localStorage.setItem("orders", JSON.stringify(orders));

        
        }
    
    function downloadInvoice(order) {
    // SAFETY CHECK
            if (!order) {
            alert("‚ùå Invoice data not found");
            return;
            }

            let popup = window.open("", "Invoice", "width=600,height=650");

            if (!popup) {
                alert("‚ùå Popup blocked. Please allow popups.");
                return;
            }

            popup.document.write(`
            <html>
            <head>
                <title>Shoe Store Invoice</title>
                <style>
                    body {
                        font-family: Arial;
                        padding: 30px;
                    }
                    h2 {
                        text-align: center;
                    }
                    .box {
                        border: 1px solid #000;
                        padding: 20px;
                    }
                    .row {
                        margin: 10px 0;
                    }
                    .label {
                        font-weight: bold;
                    }
                    .footer {
                        margin-top: 30px;
                        text-align: center;
                        font-size: 14px;
                    }
                    button {
                        margin-top: 20px;
                        padding: 10px 15px;
                        cursor: pointer;
                    }
                </style>
            </head>
            <body>

            <h2>üßæ Shoe Store Invoice</h2>

            <div class="box">
                <div class="row"><span class="label">Order ID:</span> ${order.id}</div>
                <div class="row"><span class="label">Shoe Name:</span> ${order.item}</div>
                <div class="row"><span class="label">Amount:</span> ‚Çπ${order.price}</div>
                <div class="row"><span class="label">Payment Method:</span> ${order.method}</div>
                <div class="row"><span class="label">Date:</span> ${order.date}</div>
            </div>

            <div class="footer">
                Thank you for shopping with Shoe Store üëü
            </div>

            <center>
                <button onclick="window.print()">‚¨á Print / Save as PDF</button>
            </center>

            </body>
            </html>
        `);

        popup.document.close();
    }

    document.addEventListener('click', function(e) {
                if (e.target.classList.contains('download-invoice-btn')) {
                    let orderData = e.target.getAttribute('data-order');
                    let order = JSON.parse(orderData);
                    downloadInvoice(order); // pass full object to your existing function
                }
    });

</script> 
</body>
</html>





